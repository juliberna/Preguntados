{{> navbar}}
<div class="container-fluid py-4 bg-dark">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <form method="GET" class="d-flex gap-2">
            <select name="filtro" class="form-select form-select-sm" onchange="this.form.submit()">
                <option value="dia" {{#filtro_dia}}selected{{/filtro_dia}}>Día</option>
                <option value="semana" {{#filtro_semana}}selected{{/filtro_semana}}>Semana</option>
                <option value="mes" {{#filtro_mes}}selected{{/filtro_mes}}>Mes</option>
                <option value="anio" {{#filtro_anio}}selected{{/filtro_anio}}>Año</option>
            </select>
        </form>
    </div>

    <div class="row text-center mb-4">
        <div class="col-md-3">
            <div class="p-3 rounded shadow-sm" style="background-color: #4C4C4C;">
                <h4>{{total_jugadores}}</h4>
                <p class="text-muted">Jugadores Totales</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="p-3 rounded shadow-sm" style="background-color: #4C4C4C;">
                <h4>{{partidas_jugadas}}</h4>
                <p class="text-muted">Partidas jugadas</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="p-3 rounded shadow-sm" style="background-color: #4C4C4C;">
                <h4>{{total_preguntas}}</h4>
                <p class="text-muted">Total Preguntas</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="p-3 rounded shadow-sm" style="background-color: #4C4C4C;">
                <h4>{{total_preguntas_creadas}}</h4>
                <p class="text-muted">Preguntas Creadas</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class=" p-3 rounded shadow-sm" style="background-color: #4C4C4C;">
                <h4>{{total_jugadores_nuevos}}</h4>
                <p class="text-muted">Us. nuevos</p>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div id="graficoEdad" style="height: 300px;"></div>
        </div>
        <div class="col-md-4">
            <div id="map" style="height: 300px; border-radius: 10px;"></div>
        </div>
        <div class="col-md-4">
            <div id="graficoGenero" style="height: 300px;"></div>
        </div>
    </div>



    <div class="row">
        <div class="col-md-12">
            <div class="bg-white rounded shadow-sm p-3">
                <h5 class="mb-3">Preguntas respondidas correctamente</h5>
                <div id="graficoCorrectasLinea" style="height: 300px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script>
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawCharts);

    function drawCharts() {
        // Edad
        const dataEdad = google.visualization.arrayToDataTable([
            ['Rango de edad', 'Cantidad'],
            ['Menor', {{edad_menor}}],
            ['Mediana edad', {{edad_media}}],
            ['Mayor', {{edad_mayor}}]
        ]);
        new google.visualization.PieChart(document.getElementById('graficoEdad'))
                .draw(dataEdad, {title: 'Edades', pieHole: 0.4});

        // Género
        const dataGenero = google.visualization.arrayToDataTable([
            ['Género', 'Cantidad'],
            ['Femenino', {{genero_femenino}}],
            ['Masculino', {{genero_masculino}}],
            ['No especificado', {{genero_otro}}]
        ]);
        new google.visualization.PieChart(document.getElementById('graficoGenero'))
                .draw(dataGenero, {title: 'Géneros', pieHole: 0.4});

        // Correctas por fecha (línea)
        const dataLinea = new google.visualization.DataTable();
        dataLinea.addColumn('string', 'Fecha');
        dataLinea.addColumn('number', '% Correctas');
        dataLinea.addColumn('number', '% Incorrectas');
        dataLinea.addRows([
            {{#json_grafico_correctas}}
                ['{{filtro_Actual}}', {{porcentajeCorrectas}}, {{porcentajeIncorrectas}}],
            {{/json_grafico_correctas}}
        ]);
        new google.visualization.BarChart(document.getElementById('graficoCorrectasLinea'))
                .draw(dataLinea, {
                    title: '% de Respuestas Respondidas',
                    curveType: 'function',
                    legend: { position: 'bottom' },
                    vAxis: {
                        minValue: 0,
                        maxValue: 100,
                        format: '#\'%\''
                    }
                });
    }


    // Mapa interactivo
    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const puntos = {{&json_paises_usuarios}};
    puntos.forEach(async p => {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(p.nombre_pais)}&format=json&limit=1`, {
            headers: { 'User-Agent': 'Preguntopolis/1.0' }
        });
        const data = await res.json();
        if (data.length) {
            const { lat, lon } = data[0];
            L.marker([lat, lon]).addTo(map).bindPopup(`${p.nombre_pais}: ${p.cantidad} usuarios`);
        }
    });
</script>
